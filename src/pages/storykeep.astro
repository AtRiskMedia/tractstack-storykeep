---
import StoryKeep from "@layouts/StoryKeep.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import ImpressionWrapper from "@components/ImpressionWrapper";
import { ContentSearchWrapper } from "../components/storykeep/components/ContentSearchWrapper";
import { PageViewStats } from "../components/storykeep/components/PageViewStats";
import { getFullContentMap } from "../api/turso";
import type { AuthStatus, ImpressionDatum, MenuDatum } from "../types";

// user authenticated?
const user = Astro.locals.user as AuthStatus;

// get storykeep datum
const payload = await getFullContentMap();
if (!payload) {
  return Astro.redirect("/404");
}

// menu
const links = [
  {
    name: "Logout",
    description: "Close this session",
    featured: true,
    actionLisp: "(goto (storykeep logout))",
  },
];
if (user?.isAuthenticated)
  links.unshift({
    name: "Settings",
    description: "Your Story Keep Settings",
    featured: true,
    actionLisp: "(goto (storykeep settings))",
  });
const menuPayload = {
  id: `storykeep`,
  title: "Story Keep Menu",
  theme: "default",
  optionsPayload: links,
} as MenuDatum;
// impression
const impressions = user.isOpenDemo
  ? [
      {
        id: `storykeep`,
        parentId: `storykeep`,
        title: "Would you like your website to be built with Tract Stack?",
        body: "We offer Tract Stack as a service with premium agency support.",
        actionLisp: "",
        buttonText: "Interested!",
        actionsLisp: "(goto (storyFragmentPane hello pricing))",
      },
    ]
  : ([] as ImpressionDatum[]);
---

<StoryKeep title="Welcome to your Story Keep">
  {
    user.isOpenDemo ? (
      <div class="my-1 pt-2 shadow-inner px-1">
        <span class="inline-flex items-center rounded-md bg-mygreen/20 px-4 py-1 text-lg text-black font-action w-full justify-center">
          <span class="font-bold">Demo Mode:</span> &nbsp; No changes will be
          saved. Have fun!
        </span>
      </div>
    ) : null
  }
  <Header
    title="Welcome to your Story Keep"
    menu={menuPayload}
    slug="storykeep"
    isContext={false}
    impressions={impressions}
    user={user}
    isStoryKeep={true}
  />
  <main id="main-content" class="min-h-screen">
    <div class="px-1.5 pt-1.5 pb-0 pr-0 pl-1.5 py-1.5">
      <div class="py-1.5 bg-white px-3.5 flex gap-y-12 flex-col">
        <PageViewStats client:load />
        <div class="my-12">
          THIS IS WHERE THE ENGAGEMENT ANALYTICS GRAPH GOES
        </div>
        <ContentSearchWrapper contentMap={payload} client:load />
        <div class="flex gap-6">
          <div class="rounded-md bg-mywhite shadow-inner w-fit py-3.5">
            <div class="px-3.5 py-1.5">
              <h2
                id="create-new-page-heading"
                class="block text-lg leading-6 text-black mb-2"
              >
                Create new page
              </h2>
              <div
                class="mt-1 flex flex-wrap gap-2"
                role="group"
                aria-labelledby="create-new-page-heading"
              >
                <a
                  href="/storykeep/create"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  StoryFragment
                </a>
                <a
                  href="/storykeep/create/context"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Context Page
                </a>
              </div>
            </div>
          </div>

          <div class="rounded-md bg-mywhite shadow-inner w-fit py-3.5">
            <div class="px-3.5 py-1.5">
              <h2
                id="create-new-page-heading-2"
                class="block text-lg leading-6 text-black mb-2"
              >
                Create...
              </h2>
              <div
                class="mt-1 flex flex-wrap gap-2"
                role="group"
                aria-labelledby="create-new-page-heading-2"
              >
                <a
                  href="/storykeep/create/resource"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Resource
                </a>
                <a
                  href="/storykeep/create/pane"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Pane
                </a>
                <a
                  href="/storykeep/create/menu"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Menu
                </a>
              </div>
            </div>
          </div>

          <div class="rounded-md bg-mywhite shadow-inner w-fit py-3.5">
            <div class="px-3.5 py-1.5">
              <h2
                id="create-new-page-heading-3"
                class="block text-lg leading-6 text-black mb-2"
              >
                Manage / Browse
              </h2>
              <div
                class="mt-1 flex flex-wrap gap-2"
                role="group"
                aria-labelledby="create-new-page-heading-3"
              >
                <a
                  href="/storykeep/manage/image"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Images
                </a>
                <a
                  href="/storykeep/manage/storyfragment"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  StoryFragments
                </a>
                <a
                  href="/storykeep/manage/context"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Context Pages
                </a>
                <a
                  href="/storykeep/manage/pane"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Panes
                </a>
                <a
                  href="/storykeep/manage/resources"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Resources
                </a>
                <a
                  href="/storykeep/manage/menu"
                  class="flex items-center px-3 py-1.5 rounded-md text-sm bg-white text-mydarkgrey border border-mydarkgrey hover:bg-myorange/50"
                  role="button"
                >
                  Menus
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="my-12">WHAT'S HOT CONTENT TABLE</div>
      </div>
    </div>
  </main>
  {
    impressions?.length ? (
      <ImpressionWrapper
        slug={`storykeep`}
        isContext={false}
        payload={impressions}
        client:idle
      />
    ) : null
  }
  <Footer
    menu={menuPayload}
    backToTop={true}
    slug={`storykeep`}
    isContext={false}
  />
</StoryKeep>
