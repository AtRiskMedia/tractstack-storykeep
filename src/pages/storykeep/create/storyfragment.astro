---
import { ulid } from "ulid";
import StoryKeep from "@layouts/StoryKeep.astro";
import { getTractStackIdBySlug } from "../../../api/turso";
import CreateNewPage from "@components/storykeep/components/CreateNewPage";

// confirm set-up
const hasConcierge = [
  import.meta.env.PUBLIC_CONCIERGE_STYLES_URL,
  import.meta.env.PRIVATE_CONCIERGE_BASE_URL,
  import.meta.env.PUBLIC_IMAGE_URL,
  import.meta.env.PRIVATE_CONCIERGE_SECRET,
  import.meta.env.PRIVATE_AUTH_SECRET,
].every(x => typeof x === "string" && x.length > 0);
const hasTurso = [
  import.meta.env.TURSO_DATABASE_URL,
  import.meta.env.TURSO_AUTH_TOKEN,
].every(x => typeof x === "string" && x.length > 0);
const hasBranding = [
  import.meta.env.PUBLIC_THEME,
  import.meta.env.PUBLIC_FOOTER,
  import.meta.env.PUBLIC_SLOGAN,
  import.meta.env.PUBLIC_SITE_URL,
].every(x => typeof x === "string" && x.length > 0);
const hasContent = [
  import.meta.env.PUBLIC_HOME,
  import.meta.env.PUBLIC_TRACTSTACK,
].every(x => typeof x === "string" && x.length > 0);
if (!hasConcierge || !hasTurso || !hasBranding || !hasContent) {
  return Astro.redirect("/storykeep");
}

const slug = `create`;
const newId = ulid();

const baseUrl = new URL(Astro.url.pathname, Astro.site);
const canonicalURL = new URL(`/${slug}`, baseUrl).href;

const TRACTSTACK_SLUG = import.meta.env.PUBLIC_TRACTSTACK;
const tractStackId = await getTractStackIdBySlug(TRACTSTACK_SLUG);
if (!tractStackId) {
  return Astro.redirect("/404");
}
---

<StoryKeep
  title="Create New Page"
  pubDatetime={new Date()}
  modDatetime={null}
  canonicalURL={canonicalURL}
>
  <div id="storykeep-content">
    <CreateNewPage
      mode="storyfragment"
      newId={newId}
      tractStackId={tractStackId}
      client:load
    />
  </div>
</StoryKeep>
